# 보안사고 대응 가이드 (Security Incident Handling)

침해 의심 알림 발생 시, 보안팀이 **무엇을 어떤 순서로 할지** 정리한 문서.

---

## 1. 큰 흐름

1. 포털/모니터링에서 이벤트 내용을 먼저 확인한다.
2. 서버에 접속해서 로그·프로세스·네트워크·파일 증적을 수집한다.
3. 수집한 정보를 기준으로 타임라인과 영향 범위를 정리한다.
4. 격리, 복구, 패치, 계정·키 교체를 수행한다.
5. 결과와 재발 방지 대책을 문서화한다.

---

## 2. 첫 30분 우선순위

1. **격리**
   - EDR에서 머신 isolate
   - NSG/방화벽으로 인바운드·아웃바운드 차단

2. **증거 보전**
   - VM 스냅샷, 디스크 이미지
   - 로그 삭제·재부팅 등 방지

3. **로그 덤프 시작**
   - Security/System/Application evtx, 최근 7일 CSV 추출

4. **긴급 패치 or 서비스 중지**
   - 이미 알려진 취약점이면 즉시 패치 / 서비스 일시 중단

5. **비밀번호/키 교체**
   - 관리자 계정, 서비스 계정, SSH 키, API 키

---

## 3. 포털(원격)에서 확인할 것

- Defender/EDR 알림 상세 (파일, 프로세스, IP, 계정)
- 같은 IOC로 엮인 다른 알림/인시던트
- VM 모니터링 그래프 (CPU/Network spike)
- Activity Log (RunCommand, 확장, 구성 변경)
- NSG Flow Log / Firewall / WAF 로그

---

## 4. 서버(Windows)에서 수집할 것

### 4.1 이벤트 로그 (최근 7일)

```cmd
wevtutil epl Security C:\temp\Security.evtx /q:"*[System[TimeCreated[timediff(@SystemTime) <= 604800000]]]"
wevtutil epl System   C:\temp/System.evtx    /q:"*[System[TimeCreated[timediff(@SystemTime) <= 604800000]]]"
wevtutil epl Application C:\temp\Application.evtx /q:"*[System[TimeCreated[timediff(@SystemTime) <= 604800000]]]"
```

```powershell
Get-WinEvent -FilterHashtable @{LogName='Security'; StartTime=(Get-Date).AddDays(-7)} |
  Export-Csv C:\temp\Security_last7d.csv -NoTypeInformation
```

### 4.2 프로세스 / 네트워크 스냅샷

```powershell
Get-Process |
  Sort-Object CPU -Descending |
  Select Id,ProcessName,CPU,WorkingSet |
  Export-Csv C:\temp\process_list.csv -NoTypeInformation

netstat -ano > C:\temp\netstat_now.txt

Get-NetTCPConnection |
  Select LocalAddress,LocalPort,RemoteAddress,RemotePort,OwningProcess |
  Export-Csv C:\temp\net_tcp_connections.csv -NoTypeInformation
```

### 4.3 로그인·프로세스 생성 이벤트

```powershell
Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4688; StartTime=(Get-Date).AddDays(-7)} |
  Export-Csv C:\temp\proc_create_4688.csv -NoTypeInformation

Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4624,4625; StartTime=(Get-Date).AddDays(-7)} |
  Export-Csv C:\temp\logon_events.csv -NoTypeInformation
```

### 4.4 계정 / 그룹 / 예약작업 / 서비스

```powershell
Get-LocalUser | Export-Csv C:\temp\local_users.csv -NoTypeInformation

Get-LocalGroup | ForEach-Object {
    Get-LocalGroupMember -Name $_.Name
} | Export-Csv C:\temp\local_group_members.csv -NoTypeInformation

schtasks /query /fo LIST /v > C:\temp\schtasks_verbose.txt

Get-Service | Export-Csv C:\temp\services.csv -NoTypeInformation
```

### 4.5 시작 프로그램 / 최근 변경 파일

```cmd
reg export "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" C:\temp\HKLM_Run.reg
reg export "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" C:\temp\HKCU_Run.reg
```

```powershell
Get-ChildItem -Path C:\ -Recurse -ErrorAction SilentlyContinue |
  Where-Object { $_.LastWriteTime -ge (Get-Date).AddDays(-7) } |
  Select FullName,LastWriteTime,Length |
  Export-Csv C:\temp\recent_files_7d.csv -NoTypeInformation
```

---

## 5. 추가 도구 활용 아이디어

- **osquery** : 프로세스·포트·autoruns 쿼리
- **Trivy**   : 파일시스템/이미지 취약점
- **YARA**    : 악성 패턴 매칭
- **nmap**    : 저소음 프로파일로 포트/서비스만 확인

---

## 6. 타임라인 & 보고

1. **타임라인 포맷**
   - `[시간] – [이벤트] – [계정/프로세스/IP] – [근거(Log ID, Alert ID)]`
2. **예시**
   - 08:46 – CPU 스파이크, 외부 IP 1.2.3.4 연결  
   - 08:46 – `unknown.exe` 생성 및 실행
3. **침해 확정 시**
   - 신규 VM 클린 빌드, 데이터 이관
   - 계정·키 전면 교체
   - 정책·모니터링 룰 업데이트
   - 결과 보고서 및 재발방지 계획 수립
